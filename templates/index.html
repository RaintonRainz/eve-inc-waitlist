{% extends "base.html" %}

{% block title %}Overview{% endblock %}

{% block head %}

{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){    
    $('.collapse').on('show.bs.collapse', function (e) {
    	var id = $(e.target).attr("id");
    	$.cookie(id, "open");
    	var togglerSelector = $(e.target).data("tog-icon");
       	$(togglerSelector).removeClass("fa-plus-square").addClass("fa-minus-square");
    });

    $('.collapse').on('hide.bs.collapse', function (e) {
    	var id = $(e.target).attr("id");
    	$.cookie(id, "closed");
    	var togglerSelector = $(e.target).data("tog-icon");
		$(togglerSelector).removeClass("fa-minus-square").addClass("fa-plus-square");
    });
});
function removeSelf() {
	var settings = {
			dataType: "text",
			headers: {
				'X-CSRFToken': '{{csrf_token()}}'
			},
			method: 'DELETE',
			success: function(data, status, jqxhr){
				var wlNames = [{% for wl in lists %}"{{wl.name|e}}"{% if not loop.last %},{% endif %}{% endfor %}];
				for(var i=0, len=wlNames.length; i < len; i++) {
					var wlName = wlNames[i];
					var entryId = "entry-"+wlName+"-{{ current_user.get_eve_id() }}";
					var entry = document.getElementById(entryId);
					if (entry != null) { // there is a entry for him on that wl
						entry.parentNode.removeChild(entry); // remote it from the DOM
					}
				}
			},
			url: "{{url_for('fittings.self_remove_all')}}"
	};
	$.ajax(settings);
}

function removeOwnEntry(wlName, charId, entryId) {
	var settings = {
			dataType: "text",
			headers: {
				'X-CSRFToken': '{{csrf_token()}}'
			},
			method: 'DELETE',
			success: function(data, status, jqxhr){
				var htmlId = "entry-"+wlName+"-"+charId;
				var entry = document.getElementById(htmlId);
				if (entry != null) { // there is a entry for him on that wl
					entry.parentNode.removeChild(entry); // remote it from the DOM
				}
			},
			url: "/api/self/wlentry/remove/"+entryId
	};
	$.ajax(settings);
}

function removeOwnFit(fitId, wlName, charId) {
	var settings = {
			dataType: "text",
			headers: {
				'X-CSRFToken': '{{csrf_token()}}'
			},
			method: 'DELETE',
			success: function(data, status, jqxhr){
				var entryHtmlId = "entry-"+wlName+"-"+charId;
				var fitHtmlId = "fit-"+fitId;
				var fit = document.getElementById(fitHtmlId);
				var entry = document.getElementById(entryHtmlId);
				if (fit != null) { // there is a entry for him on that wl
					fit.parentNode.removeChild(fit); // remote it from the DOM
				}
				var count = Number(entry.getAttribute("data-count"));
				if (count <= 1) {
					// no fit left, remove entry
					if (entry != null) { // there is a entry for him on that wl
						entry.parentNode.removeChild(entry); // remote it from the DOM
					}
				} else {
					count--;
					entry.setAttribute("data-count", count);
				}
			},
			url: "/api/self/fittings/remove/"+fitId
	};
	$.ajax(settings);
}
</script>
{% if perm_man.can() %}
<script type="text/javascript">
function addNewEntry(wlname, wlid, entry) {
	var entryDOM = createEntryDOM(wlname, entry);
	var wlEntryContainer = $('#wl-fits-'+wlid);
	wlEntryContainer.append(entryDOM);
}

function createHeaderDOM(wlname, entry) {
	var header = $('<div class="container"></div>');
	var charRow = $('<a href="javascript:CCPEVE.showInfo(1377, '+entry.character.id+');">'+
						'<div class="row">'+
							'<div class="col-sm-2 col-xs-4">'+
									'<img src="https://image.eveonline.com/Character/'+entry.character.id+'_32.jpg" alt="'+entry.character.name+'">'+
							'</div>'+
							'<div class="col-sm-10 ol-xs-8">'+entry.character.name+
							'</div>'+
						'</div>'+
						'</a>');
	var buttonRow = null;
	if (wlname == "queue") {
		buttonRow = $('<div class="row">'+
				'<div class="btn-group btn-group-mini" role="group" aria-label="Action Buttons">'+
					// only if it is your own entry
					//'<button type="button" class="btn btn-mini btn-warning" onclick="javascript:removeOwnEntry(\'queue\', '+entry.character.id+', '+entry.id+');">Remove Self</button>'+
										'<button type="button" class="btn btn-success" onclick="javascript:moveEntryToWaitlists('+entry.id+', '+entry.character.id+')"><i class="fa fa-thumbs-o-up"></i></button>'+
					'<button aria-expanded="true" type="button" data-toggle="collapse" data-target="#fittings-'+entry.id+'" class="btn btn-primary"><i class="fa fa-plus"></i> &#47; <i class="fa fa-minus"></i> Fits</button>'+
					'<button type="button" class="btn btn-secondary" onclick="javascript:CCPEVE.startConversation('+entry.character.id+')"><i class="fa fa-comment-o"></i></button>'+
					'<button type="button" class="btn btn-danger" onclick="javascript:removeEntry('+entry.id+', '+entry.character.id+');"><i class="fa fa-times"></i></button>'+
				'</div>'+
			'</div>');
	} else {
		buttonRow = $('<div class="row">'+
					'<div class="btn-group btn-group-mini" role="group" aria-label="Action Buttons">'+
					'<button type="button" class="btn btn-success" onclick="javascript:invitePlayer('+entry.character.id+')"><i class="fa fa-bell-o"></i></button>'+
						'<button aria-expanded="true" type="button" data-toggle="collapse" data-target="#fittings-'+entry.id+'" class="btn btn-primary"><i class="fa fa-plus"></i> &#47; <i class="fa fa-minus"></i> Fits</button>'+
						'<button type="button" class="btn btn-secondary" onclick="javascript:CCPEVE.startConversation('+entry.character.id+')"><i class="fa fa-comment-o"></i></button>'+
						'<button type="button" class="btn btn-danger" onclick="javascript:removePlayer('+entry.character.id+');"><i class="fa fa-times"></i></button>'+
						'</div>'+
				'</div>');
	}

	header.append(charRow);
	header.append(buttonRow);
	return header;
}

function createEntryDOM(wlname, entry) {
	var entryDOM = $('<li class="list-group-item" id="entry-'+wlname+'-'+entry.character.id+'" data-count="'+entry.fittings.length+'"></li>');
	var cardDOM = $('<div class="card"></div>');
	cardDOM.append(createHeaderDOM(wlname, entry));
	entryDOM.append(cardDOM);
	var fittlistDOM = $('<ul style="" aria-expanded="true" class="list-group list-group-flush collapse" id="fittings-'+entry.id+'"></ul>')
	entryDOM.append(fittlistDOM);
	for (var i=0; i<entry.fittings.length; i++) {
		fittlistDOM.append(createFitDOM(entry.fittings[i]));
	}
	return entryDOM;
}

/*
 * Returns how many new entries where created
 */
function updateWlEntry(wlname, wlid,entry) {
	var new_entry_count = 0;
	var jEntries = $('#entry-'+wlname+'-'+entry.character.id);
	if (jEntries.size() <= 0) {
		addNewEntry(wlname, wlid, entry);
		new_entry_count = 1;
	} else {
		// update fits and such
		var jFittings = $($('#fittings-'+entry.id)[0]);
		var existingFits = jFittings.children();
		// we remove fits that are not in the received data,
		// and filter out those that where already on the page
		existingFits.each(function(){
			// check if fit still exists
			var currentElement = $(this);
			var currentId = currentElement.attr("id");
			currentId = Number(currentId.slice(4));
			var is_existing = false
			for (var i=0; i < entry.fittings.length; i++ ) {
				var fit = entry.fittings[i];
				if (fit.id == currentId) {
					is_existing = true;
					entry.fittings.splice(i, 1); // this fit is already there we don't need it
					i=i-1;
					break;
				}
			}
			if (! is_existing) {
				// we need to remove the fit
				currentElement.remove();
			}
			
		});
		
		// now we add the new fits
		for (var i=0; i < entry.fittings.length; i++) {
			jFittings.append(createFitDOM(entry.fittings[i], entry.character));
		}
	}
	return new_entry_count;
}

function createFitDOM(fit, character) {
	var fitdom = $($.parseHTML('<li class="list-group-item fitting" id="fit-'+fit.id+'"></li>'))
	.append($.parseHTML('<div class="container"></div>'));
	var commentHTML = "";
	if (fit.comment != null) {
		commentHTML = '<div class="row"><small>'+fit.comment+'</small></div>';
	}
	fitdom.append(
			$($.parseHTML('<div class="row fit-link" data-dna="'+fit.dna+'"></div>'))
				.append($.parseHTML('<div class="col-sm-4"><img src="https://image.eveonline.com/Render/'+fit.shipType+'_32.png" alt="'+fit.shipName+'"></div>'))
				.append($.parseHTML('<div class="col-sm-8"><div class="row">'+fit.shipName+'</div>'+commentHTML+'</div>'))
			);
	return fitdom
	// add own fit removal button if its your own entry :/
	
}

function cleanWL(wldata) {
	var wlbody = $('#wl-fits-'+wldata.id);
	wlbody.empty();
}

function updateWaitlist(wldata) {
	var waitlist = $('#wl-'+wldata.name)[0];
	// if there are no entrys in the wl make sure that there ain't any on our page
	if (wldata.entries.length == 0) {
		cleanWL(wldata);
		setWlEntryCount(wldata.name, 0);
	} else {
		var new_entry_count = 0;
		for (var i = 0; i < wldata.entries.length; i++) {
			new_entry_count += updateWlEntry(wldata.name, wldata.id, wldata.entries[i]);
		}
		// now that all are updated delete entrys that are not in existance
		var entries = $('li[id|="entry-'+wldata.name+'"]');
		var preLen = ("entry-"+wldata.name+"-").length;
		for (var i=0; i < entries.size(); i++) {
			var id = $(entries[i]).attr("id");
			id = Number(id.slice(preLen))
			var is_existing = false;
			for (var n=0; n < wldata.entries.length; n++) {
				if (wldata.entries[n].character.id == id) {
					is_existing = true;
					break;
				}
			}
			if (! is_existing) {
				$(entries[i]).remove();
				new_entry_count -= 1;
			}
		}
		var oldCount = Number(getWlEntryCount(wldata.name));
		var newCount = oldCount + new_entry_count;
		setWlEntryCount(wldata.name, newCount);
	}
}

function setWlEntryCount(wlname, count) {
	var dataElement = $('#wl-'+wlname);
	dataElement.data("count", count);
	var textElement = $('#wl-count-'+wlname);
	textElement.text(count);
}

function getWlEntryCount(wlname) {
	var dataElement = $('#wl-'+wlname);
	return dataElement.data("count");
}

function refreshWl() {
	$.getJSON("{{url_for('waitlist_api.waitlist')}}", function(data){
		for (var i=0; i < data.waitlists.length; i++) {
			updateWaitlist(data.waitlists[i]);
		}
	});
}

function invitePlayer(userId) {
	$.post("{{url_for('fittings.api_invite_player')}}", {'playerId': userId, '_csrf_token': '{{ csrf_token() }}'}, function(){
	}, "text");
}

function removePlayer(userId) {
	$.post("{{url_for('fittings.api_wls_remove_player')}}", {'playerId': userId, '_csrf_token': '{{ csrf_token() }}'}, function(){
		clearInterval(lastRefreshInterval);
		refreshWl();
		lastRefreshInterval = setInterval(refreshWl, 10000);
	}, "text");
	var wl_names = [{% for wl in lists %}"{{wl.name|e}}",{% endfor %}];
	for (idx in wl_names) {
		var wl_name = wl_names[idx]
		var entry_id = "entry-"+wl_name+"-"+userId
		var entry = document.getElementById(entry_id);
		if (entry != null) { // there is a entry for him on that wl
			entry.parentNode.removeChild(entry); // remote it from the DOM
		}
	 }
}

function removeEntry(entryId, userId) {
	$.post("{{url_for('fittings.api_wl_remove_entry')}}", {'entryId': entryId, '_csrf_token': '{{ csrf_token() }}'}, function(){
		clearInterval(lastRefreshInterval);
		refreshWl();
		lastRefreshInterval = setInterval(refreshWl, 10000);
	}, "text");
	var entry_id = "entry-queue-"+userId
	var entry = document.getElementById(entry_id);
	if (entry != null) { // there is a entry for him on that wl
		entry.parentNode.removeChild(entry); // remote it from the DOM
	}
}

function moveEntryToWaitlists(entryId, userId) {
	$.post("{{url_for('fittings.move_to_waitlists')}}", {'entryId': entryId, '_csrf_token': '{{ csrf_token() }}'}, function(){
		clearInterval(lastRefreshInterval);
		refreshWl();
		lastRefreshInterval = setInterval(refreshWl, 10000);
	}, "text");
	var entry_id = "entry-queue-"+userId
	var entry = document.getElementById(entry_id);
	if (entry != null) { // there is a entry for him on that wl
		entry.parentNode.removeChild(entry); // remote it from the DOM
	}
}

$(document).ready(function(){
	var wlists = $('ol[id|="wl-fits"]');
	for (var i=0; i < wlists.size(); i++) {
		var wl = $(wlists[i]);
		var wlId = wl.attr("id");
		var cookie = $.cookie(wlId);
		if (cookie == null) {
			$.cookie(wlId, "closed");
			cookie = "closed";
		}

		if (cookie == "closed") {
			wl.collapse('hide');
		} else if (cookie == "open") {
			wl.collapse('show');
		}
	}
	refreshWl();
	lastRefreshInterval = setInterval(refreshWl, 10000);
});
</script>
{% endif %}
{% if perm_viewfits.can() %}
<script src="https://quiescens.duckdns.org/wl/wtm.js"></script>
{% endif %}
{% endblock %}

{% block container_data %}
<div class="row">
	<div class="col-sm-6">
	<div class="card">
		<div style="cursor: pointer;" class="card-header" id="status-heading" data-toggle="collapse" data-target="#status-body" id="status-toggle">
	      <h4 class="card-title">
	          Status: {{fleet.status}}<i id="status-tog-icon" class="fa fa-plus-square pull-xs-right" id="status-icon"></i>
	      </h4>
	    </div>
	    <div class="">
	    <table class="table-sm">
	    <tbody>
	    <tr>
	    	<th scope="row">Fleet Manager</th>
	    	<td>{% if fleet.manager is not none %}<a href="javascript:CCPEVE.showInfo(1377, {{fleet.manager[1]}});">{{fleet.manager[0]}}</a>{% else %}Not Set{% endif %}</td>
	    </tr>
	    </tbody>
	    </table>
	    </div>
	    <div id="status-body" class="collapse" data-tog-icon="#status-tog-icon">
		    <table class="table-sm">
		    <tbody>
		    <!--
		    <tr>
		    	<th scope="row">FC</th>
		    	<td>{% if fleet.fc is not none %}<a href="javascript:CCPEVE.showInfo(1377, {{fleet.fc[1]}});">{{fleet.fc[0]}}</a>{% else %}Not Set{% endif %}</td>
		    </tr>
			
		    <tr>
		    	<th scope="row">Fleet Manager</th>
		    	<td>{% if fleet.manager is not none %}<a href="javascript:CCPEVE.showInfo(1377, {{fleet.manager[1]}});">{{fleet.manager[0]}}</a>{% else %}Not Set{% endif %}</td>
		    </tr>
		    -->
		    <tr>
		    	<th scope="row">Constellation</th>
		    	<td>{% if fleet.constellation is not none %}<a href="javascript:CCPEVE.showInfo(4, {{fleet.constellation[1]}});">{{fleet.constellation[0]}}</a>{% else %}Not Set{% endif %}</td>
		    </tr>
		    <tr>
		    	<th scope="row">Dockup</th>
		    	<td>{% if fleet.dock is not none %}<a href="javascript:CCPEVE.setDestination({{fleet.dock[1]}});">{{fleet.dock[0]}}</a>{% else %}Not Set{% endif %}</td>
		    </tr>
		    <tr>
		    	<th scope="row">HQ System</th>
		    	<td>{% if fleet.systemhq is not none %}<a href="javascript:CCPEVE.showInfo(5, {{fleet.systemhq[1]}});">{{fleet.systemhq[0]}}</a>{% else %}Not Set{% endif %}</td>
		    </tr>
		    </tbody>
		    </table>
    	</div>
    </div>
	</div>
	<div class="col-sm-6">
		<div class="alert alert-info" role="alert">
  			<p class="text-xs-center"><strong>Help us!</strong> We would like your <a href="{{url_for('feedback.index')}}">feedback</a>!</p>
		</div>
		{% if not xup_open %}
		<div class="alert alert-warning" role="alert">
  			<p class="text-xs-center">X-up is currently closed!</p>
		</div>
		{% endif %}
	</div>
</div>
<div class="row" id="row-waitlists">
<div id="waitlists">
{% for wlist in lists %}
<div class="col-sm-3" id="wl-{{ wlist.name }}" data-count="{% if not perm_man.can() %}{{wlist.entries|length}}{% else %}0{% endif %}">
	<div class="panel panel-default">
		<div class="panel-heading" role="tab" id="wl-{{ wlist.id }}-heading">
      		<h4 class="panel-title">
        	<a  class="list-group-item text-capitalize" data-toggle="collapse" data-parent="#wl-{{ wlist.id }}-tog" data-target="#wl-fits-{{ wlist.id }}" aria-expanded="true" aria-controls="wl-fits-{{ wlist.id }}">
				{% if wlist.name == "queue" %}X-UP{% else %}{{ wlist.name|e }} WL{% endif %}<span id="wl-count-{{ wlist.name }}" class="label label-pill label-default pull-xs-left">{% if not perm_man.can() %}{{wlist.entries|length}}{% else %}0{% endif %}</span><i class="fa fa-minus-square pull-xs-right" id="wl-{{ wlist.id }}-tog-icon"></i>
        	</a>
      		</h4>
    	</div>
		<ol data-tog-icon="#wl-{{ wlist.id }}-tog-icon" class="list-group collapse in" id="wl-fits-{{ wlist.id }}" role="tabpanel" aria-labelledby="wl-heading-{{ wlist.id }}">
			{% if not perm_man.can() %}
			{% for entry in wlist.entries %}
			<li class="list-group-item"
				id="entry-{{wlist.name}}-{{ entry.user }}" {% if user.get_eve_id() == entry.user %}data-count="{{entry.fittings|length}}"{% endif %}>
				<div class="card">
					<div class="container">
						{% if user.get_eve_id() == entry.user or perm_man.can() %}
						<a href="javascript:CCPEVE.showInfo(1377, {{ entry.user }});">
						{% endif %}
						<div class="row">
						
							<div class="col-sm-2 col-xs-4">
									<img
									src="https://image.eveonline.com/Character/{{ entry.user }}_32.jpg"
									alt="{{ entry.user_data.eve_name|e }}">
							</div>
							<div class="col-sm-10 ol-xs-8">
								{{ entry.user_data.eve_name|e }}{% if entry.user_data.is_new() %} <span class="label label-info">New</span>{% endif %}
							</div>
	
						</div>
						{% if current_user.get_eve_id() == entry.user or perm_man.can() %}
						</a>
						{% endif %}
						{% if user.get_eve_id() == entry.user or perm_viewfits.can() %}
						<div class="row">
							<div class="btn-group btn-group-mini" role="group" aria-label="Action Buttons">
								{% if user.get_eve_id() == entry.user %}
								<button type="button" class="btn btn-mini btn-warning"
									onclick="javascript:removeOwnEntry('{{wlist.name}}', {{entry.user}}, {{ entry.id }});">Remove Self</button>
								{% endif %}
								{% if user.get_eve_id() == entry.user or perm_viewfits.can() %}
								<button type="button" data-toggle="collapse" data-target="#fittings-{{entry.id}}" class="btn btn-primary">Show/Hide Fits</button>
								{% endif %}
								
								{% if perm_man.can() %}
								<button type="button" class="btn btn-secondary" onclick="javascript:CCPEVE.startConversation({{ entry.user }})">Convo</button>
								{% if wlist.name == "queue" %}
								{# Button for X-Up list and FleetComp #}
								<button type="button" class="btn btn-danger"  onclick="javascript:removeEntry({{entry.id}}, {{entry.user}});">Remove</button>
								<button type="button" class="btn btn-success" onclick="javascript:moveEntryToWaitlists({{ entry.id }}, {{ entry.user }})">Approve</button>
								{% else %}
								{# Buttons for Waitlist and FleetComp #}
								<button type="button" class="btn btn-danger" onclick="javascript:removePlayer({{entry.user}});">Remove Player</button>
								<button type="button" class="btn btn-success" onclick="javascript:invitePlayer({{ entry.user }})">Send Notification</button>
								{% endif %}
								
								{% endif %}
							</div>
						</div>
						{% endif %}
					</div>
					{% if user.get_eve_id() == entry.user or perm_viewfits.can() %}
					<ul class="list-group list-group-flush collapse" id="fittings-{{entry.id}}">
						{% for fit in entry.fittings %}
						<li class="list-group-item fitting" id="fit-{{ fit.id }}">
							<div class="container">
								<div class="row fit-link" data-dna="{{ fit.ship_type }}:{{ fit.modules }}">
									<div class="col-sm-4">
										<img
											src="https://image.eveonline.com/Render/{{ fit.ship_type }}_32.png"
											alt="{{ fit.ship.typeName }}">
									</div>
									<div class="col-sm-8">
										<div class="row">{{ fit.ship.typeName|e }}</div>
										{% if fit.comment is not none %}
										<div class="row"><small>{{ fit.comment|safe }}</small></div>
										{% endif %}
									</div>
								</div>
								{% if user.get_eve_id() == entry.user %}
								<div class="row">
									<div class="btn-group btn-group-mini" role="group"
										aria-label="Action Buttons">
										<button type="button" class="btn btn-mini btn-warning"
											onclick="javascript:removeOwnFit({{ fit.id }}, '{{ wlist.name }}', {{ entry.user }});">Remove Fit</button>
									</div>
								</div>
								{% endif %}
							</div>
						</li>
						{% endfor %}
					</ul>
					{% endif %}
				</div>
			</li> {% endfor %}
			{% endif %}
		</ol>
	</div>
</div>
{% endfor %}
</div>
</div>
{% endblock %}
